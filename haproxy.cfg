global
  # log to stdout
  log stdout format raw local0 debug
  stats socket ipv4@127.0.0.1:9999 level admin
  stats socket /var/run/hapee-lb.sock mode 666 level admin
  stats timeout 2m

defaults
  log               global
  option            httplog
  retries           3
  maxconn           2000
  timeout connect   50s
  timeout client    50s
  timeout server    50s
  timeout client-fin 30s
  timeout tunnel    10h

frontend main
  bind *:80
  mode http

  option http-keep-alive

  # Capture for logging
  http-request capture path len 200

  # Route requests containing gemini-3-pro-preview to the gemini backend
  # use_backend gemini_global if { path -m reg gemini-3-pro-preview }

  # Default backend
  default_backend gemini_global

backend gemini_global
  mode http
  retry-on 429
  retries 3

  # Keep the original path unchanged
  # Request: /v1/projects/cloud-llm-preview4/locations/global/publishers/google/models/gemini-3-pro-preview:generateContent
  # Forwards as-is to aiplatform.googleapis.com

  # Set the host header to Google's API endpoint
  http-request set-header host aiplatform.googleapis.com

  # Forward to Google's aiplatform.googleapis.com
  server google-aiplatform aiplatform.googleapis.com:443 ssl verify none
